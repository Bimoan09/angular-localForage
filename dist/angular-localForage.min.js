/**
 * angular-localforage - Angular service & directive for https://github.com/mozilla/localForage (Offline storage, improved.)
 * @version v0.2.9
 * @link https://github.com/ocombe/angular-localForage
 * @license MIT
 * @author Olivier Combe <olivier.combe@gmail.com>
 */
!function(e,n,t){"use strict";var r=n.module("LocalForageModule",["ng"]);r.provider("$localForage",function(){t.config({name:"lf"}),this.notify={setItem:!1,removeItem:!1};var e=function(e){return t.setDriver(e)};this.setDriver=e;var r=function(){return t.driver()};this.setNotify=function(e,n){this.notify={setItem:e,removeItem:n}},this.config=function(r){return n.isObject(r)||(r={}),n.isDefined(r.driver)?(t.config(r),e(r.driver)):t.config(r)},this.$get=["$rootScope","$q","$parse",function(i,o,a){var s=this.notify,u={},c=function(){return"localStorageWrapper"===r()?t.config().name+".":""},f=function(t,i,o,a){(n.isObject(t)&&t.name?"InvalidStateError"===t.name:n.isString(t)&&"InvalidStateError"===t)&&"asyncStorage"===r()||n.isObject(t)&&t.code&&5===t.code?e("localStorageWrapper").then(function(){o.apply(this,i).then(function(e){a.resolve(e)},function(e){a.reject(e)})},function(){a.reject(t)}):a.reject(t)},l=function(e,r){var a=o.defer(),u=arguments;return n.isObject(r)&&n.isDefined(r.$promise)&&delete r.$promise,n.isArray(r)&&n.forEach(r,function(e,t){n.isDefined(e.$$hashKey)&&0===t&&(r=n.fromJson(n.toJson(r)))}),t.setItem(c()+e,r).then(function(){s.setItem&&i.$broadcast("LocalForageModule.setItem",{key:e,newvalue:r,driver:t.driver()}),a.resolve(r)},function(e){f(e,u,l,a)}),a.promise},d=function(e){var n=o.defer(),r=arguments;return t.getItem(c()+e).then(function(e){n.resolve(e)},function(e){f(e,r,d,n)}),n.promise},v=function(e){var n=t.removeItem(c()+e);return s.removeItem?n.then(function(){i.$broadcast("LocalForageModule.removeItem",{key:e,driver:t.driver()})}):n},m=function(){var e=o.defer(),t=arguments,r=[];return y().then(function(t){n.forEach(t,function(e){r.push(v(e))}),o.all(r).then(function(){e.resolve()})},function(n){f(n,t,m,e)}),e.promise},g=function(e){var n=o.defer(),r=arguments;return t.key(e).then(function(e){n.resolve(e)},function(e){f(e,r,g,n)}),n.promise},h=function(){var e=o.defer(),n=arguments;return t.length().then(function(n){e.resolve(n)},function(t){f(t,n,h,e)}),e.promise},y=function(){var e=o.defer(),n=arguments;return t.keys().then(function(n){for(var t=c(),r=[],i=0,o=n.length;o>i;i++)n[i]&&0===n[i].indexOf(t)&&r.push(n[i].substr(t.length,n[i].length));e.resolve(r)},function(t){f(t,n,y,e)}),e.promise},p=function(e,t){if(n.isString(t))t={key:t};else if(!n.isObject(t)||n.isUndefined(t.key))throw"You must defined a key to bind";var r={defaultValue:"",storeName:""};t=n.extend(r,t||{});var i=t.storeName||t.key,o=a(i);return d(i).then(function(r){return r?o.assign(e,r):t.defaultValue&&l(i,t.defaultValue),n.isDefined(u[t.key])&&u[t.key](),u[t.key]=e.$watch(a(t.key),function(e){n.isDefined(e)&&l(i,e)},!0),r})},k=function(e,t,r){r=r||t,a(t).assign(e,null),n.isDefined(u[t])&&(u[t](),delete u[t]),v(r)};return{setDriver:e,driver:r,getDriver:r,setItem:l,set:l,getItem:d,get:d,remove:v,removeItem:v,clear:m,clearAll:m,key:g,getKeyAt:g,keys:y,getKeys:y,length:h,getLength:h,bind:p,unbind:k}}]}),r.directive("localForage",["$localForage",function(e){return{restrict:"A",link:function(t,r,i){var o=t.$eval(i.localForage);n.isObject(o)&&n.isDefined(o.key)&&n.isDefined(o.storeName)?e.bind(t,o):e.bind(t,i.localForage)}}}])}(window,window.angular,window.localforage);