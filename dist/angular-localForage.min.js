/**
 * angular-localForage - Angular service & directive for https://github.com/mozilla/localForage (Offline storage, improved.)
 * @version v0.2.7
 * @link https://github.com/ocombe/angular-localForage
 * @license MIT
 * @author Olivier Combe <olivier.combe@gmail.com>
 */
!function(e,n,t){"use strict";var r=n.module("LocalForageModule",["ng"]);r.provider("$localForage",function(){t.config({name:"lf"}),this.notify={setItem:!1,removeItem:!1};var e=function(e){return t.setDriver(e)};this.setDriver=e;var r=function(){return t.driver()};this.setNotify=function(e,n){this.notify={setItem:e,removeItem:n}},this.config=function(r){n.isObject(r)||(r={});var i=/firefox/i.test(navigator.userAgent);if(i){try{var o=o||this.indexedDB||this.webkitIndexedDB||this.mozIndexedDB||this.OIndexedDB||this.msIndexedDB,a=o.open("_localforage_spec_test",1);a.onerror=function(){u=!1};var u=o&&null===a.onupgradeneeded}catch(c){u=!1}u||(r.driver="localStorageWrapper")}return n.isDefined(r.driver)?(t.config(r),e(r.driver)):t.config(r)},this.$get=["$rootScope","$q","$parse",function(i,o,a){var u=this.notify,c={},s=function(){return"localStorageWrapper"===r()?t.config().name+".":""},f=function(n,t,i,o){"InvalidStateError"===n&&"asyncStorage"===r()?e("localStorageWrapper").then(function(){i(t).then(function(e){o.resolve(e)},function(e){o.reject(e)})},function(){o.reject(n)}):o.reject(n)},l=function(e,r){var a=o.defer(),c=arguments;return n.isObject(r)&&n.isDefined(r.$promise)&&delete r.$promise,t.setItem(s()+e,r).then(function(){u.setItem&&i.$broadcast("LocalForageModule.setItem",{key:e,newvalue:r,driver:t.driver()}),a.resolve(r)},function(e){f(e,c,l,a)}),a.promise},d=function(e){var n=o.defer(),r=arguments;return t.getItem(s()+e).then(function(e){n.resolve(e)},function(e){f(e,r,d,n)}),n.promise},v=function(e){var n=t.removeItem(s()+e);return u.removeItem?n.then(function(){i.$broadcast("LocalForageModule.removeItem",{key:e,driver:t.driver()})}):n},g=function(){var e=o.defer(),t=arguments,r=[];return p().then(function(t){n.forEach(t,function(e){r.push(v(e))}),o.all(r).then(function(){e.resolve()})},function(n){f(n,t,clearAll,e)}),e.promise},m=function(e){var n=o.defer(),r=arguments;return t.key(e).then(function(e){n.resolve(e)},function(e){f(e,r,m,n)}),n.promise},h=function(){var e=o.defer(),n=arguments;return t.length().then(function(n){e.resolve(n)},function(t){f(t,n,h,e)}),e.promise},p=function(){var e=o.defer(),n=arguments;return h().then(function(n){for(var t=[],r=[],i=s(),a=0;n>a;a++)t.push(m(a).then(function(e){e&&0===e.indexOf(i)&&r.push(e.substr(i.length,e.length))}));o.all(t).then(function(){e.resolve(r)})},function(t){f(t,n,p,e)}),e.promise},y=function(e,t){if(n.isString(t))t={key:t};else if(!n.isObject(t)||n.isUndefined(t.key))throw"You must defined a key to bind";var r={defaultValue:"",storeName:""};t=n.extend(r,t||{});var i=t.storeName||t.key,o=a(t.key);return d(i).then(function(r){return r?o.assign(e,r):t.defaultValue&&l(i,t.defaultValue),n.isDefined(c[t.key])&&c[t.key](),c[t.key]=e.$watch(a(t.key),function(e){n.isDefined(e)&&l(i,e)},!0),r})},I=function(e,t,r){r=r||t,a(t).assign(e,null),n.isDefined(c[t])&&(c[t](),delete c[t]),v(r)};return{setDriver:e,driver:r,getDriver:r,setItem:l,set:l,getItem:d,get:d,remove:v,removeItem:v,clear:g,clearAll:g,key:m,getKeyAt:m,getKeys:p,length:h,getLength:h,bind:y,unbind:I}}]}),r.directive("localForage",["$localForage",function(e){return{restrict:"A",link:function(t,r,i){var o=t.$eval(i.localForage);n.isObject(o)&&n.isDefined(o.key)&&n.isDefined(o.storeName)?e.bind(t,o):e.bind(t,i.localForage)}}}])}(window,window.angular,window.localforage);