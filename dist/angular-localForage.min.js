/**
 * angular-localforage - Angular service & directive for https://github.com/mozilla/localForage (Offline storage, improved.)
 * @version v1.0.0
 * @link https://github.com/ocombe/angular-localForage
 * @license MIT
 * @author Olivier Combe <olivier.combe@gmail.com>
 */
(function(e,t,n,r){"use strict";var i=t.module("LocalForageModule",["ng"]);i.provider("$localForage",function(){var e={},r={name:"lf"},i={setItem:false,removeItem:false},s={};this.setNotify=function(e,t){i={setItem:e,removeItem:t}};this.config=function(e){if(!t.isObject(e)){throw new Error("The config parameter should be an object")}t.extend(r,e)};this.$get=["$rootScope","$q","$parse",function(o,u,a){var f=function(i){if(t.isDefined(i)){this._localforage=n.createInstance(i)}else{this._localforage=n;n.config(r)}};f.prototype.createInstance=function(i){if(t.isObject(i)){i=t.extend({},r,i);if(t.isDefined(e[i.name])){throw new Error("A localForage instance with the name "+i.name+" is already defined.")}e[i.name]=new f(i);return e[i.name]}else{throw new Error("The parameter should be a config object.")}};f.prototype.instance=function(i){if(t.isUndefined(i)){return e[r.name]}else if(t.isString(i)){if(t.isDefined(e[i])){return e[i]}else{throw new Error("No localForage instance of that name exists.")}}else{throw new Error("The parameter should be a string.")}};f.prototype.setDriver=function(t){return this._localforage.setDriver(t)};f.prototype.driver=function(){return this._localforage.driver()};f.prototype.setItem=function(n,r){if(t.isUndefined(n)){throw new Error("You must define a key to set")}var s=u.defer(),a=arguments,f=t.copy(r),l=this;if(t.isObject(f)&&t.isDefined(f.$promise)){delete f.$promise}l._localforage.setItem(l.prefix()+n,f).then(function(){if(i.setItem){o.$broadcast("LocalForageModule.setItem",{key:n,newvalue:f,driver:l.driver()})}s.resolve(f)},function(t){l.onError(t,a,l.setItem,s)});return s.promise};f.prototype.getItem=function(n){if(t.isUndefined(n)){throw new Error("You must define a key to get")}var r=u.defer(),i=arguments,s=this;s._localforage.getItem(s.prefix()+n).then(function(t){r.resolve(t)},function(t){s.onError(t,i,s.getItem,r)});return r.promise};f.prototype.iterate=function(n){if(t.isUndefined(n)){throw new Error("You must define a callback to iterate")}var r=u.defer(),i=arguments,s=this;s._localforage.iterate(n).then(function(t){r.resolve(t)},function(t){s.onError(t,i,s.iterate,r)});return r.promise};f.prototype.removeItem=function(n){if(t.isUndefined(n)){throw new Error("You must define a key to remove")}var r=u.defer(),s=arguments,a=this;a._localforage.removeItem(a.prefix()+n).then(function(){r.resolve()},function(t){a.onError(t,s,a.removeItem,r)});if(i.removeItem){return r.promise.then(function(e){o.$broadcast("LocalForageModule.removeItem",{key:n,driver:a.driver()})})}else{return r.promise}};f.prototype.clear=function(){var t=u.defer(),n=arguments,r=this;r._localforage.clear().then(function(n){t.resolve()},function(i){r.onError(i,n,r.clear,t)});return t.promise};f.prototype.key=function(n){if(t.isUndefined(n)){throw new Error("You must define a position to get for the key function")}var r=u.defer(),i=arguments,s=this;s._localforage.key(n).then(function(t){r.resolve(t)},function(t){s.onError(t,i,s.key,r)});return r.promise};var l=function(){var t=u.defer(),n=arguments,i=this;i._localforage.keys().then(function(n){if(r.oldPrefix&&i.driver()==="localStorageWrapper"){var s=[];for(var o=0,u=n.length;o<u;o++){s.push(n[o].substr(i.prefix().length,n[o].length))}n=s}t.resolve(n)},function(r){i.onError(r,n,i.keys,t)});return t.promise};f.prototype.keys=l;f.prototype.getKeys=l;f.prototype.length=function(){var e=u.defer(),t=arguments,n=this;n._localforage.length().then(function(n){e.resolve(n)},function(i){n.onError(i,t,length,e)});return e.promise};f.prototype.bind=function(i,o){if(t.isString(o)){o={key:o}}else if(!t.isObject(o)||t.isUndefined(o.key)){throw new Error("You must define a key to bind")}var u={defaultValue:"",name:r.name};o=t.extend({},u,o);var f=e[o.name];if(t.isUndefined(f)){throw new Error("You must use the name of an existing instance")}var l=o.scopeKey||o.key,c=a(l);return f.getItem(o.key).then(function(e){if(e){c.assign(i,e)}else if(o.defaultValue){c.assign(i,o.defaultValue);f.setItem(o.key,o.defaultValue)}if(t.isDefined(s[o.key])){s[o.key]()}s[o.key]=i.$watch(l,function(e){if(t.isDefined(e)){f.setItem(o.key,e)}},true);return e})};f.prototype.unbind=function(i,o){if(t.isString(o)){o={key:o}}else if(!t.isObject(o)||t.isUndefined(o.key)){throw new Error("You must define a key to unbind")}var u={scopeKey:o.key,name:r.name};o=t.extend({},u,o);var f=e[o.name];if(t.isUndefined(f)){throw new Error("You must use the name of an existing instance")}a(o.scopeKey).assign(i,null);if(t.isDefined(s[o.key])){s[o.key]();delete s[o.key]}return f.removeItem(o.key)};f.prototype.prefix=function(){return this.driver()==="localStorageWrapper"&&r.oldPrefix?this._localforage.config().name+".":""};f.prototype.onError=function(e,n,r,i){if((t.isObject(e)&&e.name?e.name==="InvalidStateError":t.isString(e)&&e==="InvalidStateError")&&this.driver()==="asyncStorage"||t.isObject(e)&&e.code&&e.code===5){var s=this;s.setDriver("localStorageWrapper").then(function(){r.apply(s,n).then(function(e){i.resolve(e)},function(e){i.reject(e)})},function(){i.reject(e)})}else{i.reject(e)}};e[r.name]=new f;return e[r.name]}]});i.directive("localForage",["$localForage",function(e){return{restrict:"A",link:function(n,r,i){var s=n.$eval(i.localForage);if(t.isObject(s)&&t.isDefined(s.key)){e.bind(n,s)}else{e.bind(n,i.localForage)}}}}])})(window,window.angular,window.localforage)